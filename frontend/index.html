<!doctype html>
<html>
<head>
  <title>Web Score</title>
  <style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font: 13px Helvetica, Arial; }
  form { background: #000; padding: 3px; position: fixed; bottom: 0; width: 30%; }
  form input { border: 0; padding: 10px; width: 90%; margin-right: .5%; }
  form button { width: 9%; background: rgb(130, 224, 255); border: none; padding: 10px; }
  #messages { list-style-type: none; margin: 0; padding: 0; }
  #messages li { padding: 5px 10px; }
  #messages li:nth-child(odd) { background: #eee; }
  </style>
</head>
<body>
  <canvas id="canvas"></canvas><br>
  <ul id="messages"></ul>


  <script src="/helpers.js"></script>

  <script>
  var lastTime = Date.now();

  const url = 'ws://192.168.1.22:8081'
  const connection = new WebSocket(url)
  //
  // $(function () {
  //   connection.onmessage = (e) => {
  //
  //     var midiEvent = JSON.parse(e.data);
  //
  //     console.log("RECEIVED MIDI NOTE " + midiEvent['note'] + ' VEL ' + midiEvent['velocity']);
  //     var now = Date.now();
  //     var deltaT = now - lastTime;
  //     lastTime = now;
  //     $('#messages').append($('<li>').text(deltaT));
  //   }
  // });


  var start;
  var stopId;
  var progress;
  var toggle = false;

  var onNotes = [];
  const painter = new FloatyNotes();

  function onWindowResize() {
    painter.resize(0);
  }


  // Event listeners.
  window.addEventListener('resize', onWindowResize);
  window.addEventListener('orientationchange', onWindowResize);


  // init
  onWindowResize();
  window.requestAnimationFrame(() => painter.drawLoop());

  connection.onmessage = (e) => {

    var midiEvent = JSON.parse(e.data);

    console.log("RECEIVED MIDI NOTE " + midiEvent['note'] + ' VEL ' + midiEvent['velocity']);

    // NOTEON event
    if (midiEvent['velocity'] > 0){

      var pitch = midiEvent['note'];

      // this assumes pitch values are ints starting at 0.
      var buttonIndex = pitch;
      var noteWidth = 50;
      const noteToPaint = painter.addNote(buttonIndex, pitch * noteWidth, noteWidth);

      onNotes[pitch] = noteToPaint;

      rect.setAttribute("style",
      "background: blue; position: absolute; width: " + pitch +"px; height: " + pitch + "px; top: 50px;");
    } else {
       // NOTEOFF event
       var pitch = midiEvent['note'];

       painter.stopNote(onNotes[pitch]);

       console.log('NOTE OFF ' + pitch);
    }
  }

  // /// DELETE THIS EVENTUALLY
  // function step(timestamp) {
  //   if (!start || progress > 400) start = timestamp;
  //   progress = (timestamp - start) / 10 + 50;
  //   rect.style.top = progress + 'px';
  //   stopId = window.requestAnimationFrame(step);
  // }
  //
  // function toggleAnimation() {
  //   if (!toggle) {
  //     toggle = true;
  //     window.requestAnimationFrame(step);
  //   } else {
  //     toggle = false;
  //     cancelAnimationFrame(stopId);
  //   }
  // }

  </script>


</body>
</html>
